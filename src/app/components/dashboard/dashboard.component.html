<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <img src="assets/icon/logo.png" alt="Logo" class="header-logo" />
    </ion-buttons>
    <ion-title color="dark">FrontMan</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleMap()">
        <ion-icon [name]="showMap ? 'list-outline' : 'map-outline'"></ion-icon>
      </ion-button>
      <ion-button (click)="toggleFilters()">
        <ion-icon name="filter-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="resetFilters()">
        <img src="assets/icon/refresh-icon.png" alt="Refresh" class="header-icon" />
      </ion-button>
      <ion-button (click)="logout()">
        <img src="assets/icon/logout-icon.png" alt="Logout" class="header-icon" />
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" [fullscreen]="true">

  <!-- Top Search Bar -->
  <ion-searchbar placeholder="name, province, city, suburb, manager..." [value]="filterState.searchTerm"
    (ionChange)="onSearchChange($event)" class="custom-searchbar duplicate-searchbar">
  </ion-searchbar>

  <!-- Map View (Always Visible) -->
  <div class="map-wrapper">
    <app-map-view [clients]="(filteredCompanies$ | async) ?? []"></app-map-view>
  </div>

  <!-- Unvisited Stats -->
  <ion-card class="stats-card" *ngIf="overdueStats$ | async as stats">
    <ion-card-content>
      <div class="stats-text">Unvisited in last 60 days</div>
      <div class="stats-percentage">{{ stats.percentage | number:'1.1-1' }}%</div>
      <div class="stats-count">{{ stats.count }} of {{ (filteredCompanies$ | async)?.length }} clients</div>
    </ion-card-content>
  </ion-card>

  <!-- Filter Panel -->
  <div class="filter-section">

    <!-- Manager Filter -->
    <div class="filter-group">
      <div class="filter-header">
        Filter by Account Manager
      </div>
      <div class="filter-content">
        <div class="chip-grid">
          <ion-chip *ngFor="let manager of managers$ | async"
            [outline]="!filterState.selectedManagers.includes(manager)"
            [class.selected-chip]="filterState.selectedManagers.includes(manager)" (click)="onManagerChange(manager)">
            <ion-label>{{ manager }}</ion-label>
            <ion-badge>{{ (managerCounts$ | async)?.get(manager) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Region Filter -->
    <div class="filter-group">
      <div class="filter-header">
        Filter by Region
      </div>
      <div class="filter-content">

        <!-- Custom Region Toggles matching design -->
        <div class="region-filter-container">
          <div class="region-toggle" [class.selected]="filterState.selectedRegions.includes('Inland')"
            (click)="onRegionToggle('Inland')">
            <span class="label">INLAND</span>
            <span class="count">{{ inlandCount$ | async }}</span>
          </div>
          <div class="region-toggle" [class.selected]="filterState.selectedRegions.includes('Coastal')"
            (click)="onRegionToggle('Coastal')">
            <span class="label">COASTAL</span>
            <span class="count">{{ coastalCount$ | async }}</span>
          </div>
        </div>

        <div class="chip-grid ion-margin-top">
          <ion-chip *ngFor="let province of provinces$ | async"
            [outline]="!filterState.selectedProvinces.includes(province)"
            [class.selected-chip]="filterState.selectedProvinces.includes(province)"
            (click)="onProvinceChange(province)">
            <ion-label>{{ province }}</ion-label>
            <ion-badge>{{ (provinceCounts$ | async)?.get(province) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Product Filter -->
    <div class="filter-group">
      <div class="filter-header product-filter-header">
        <span>Filter by Product</span>
        <div class="product-filter-toggle">
          <ion-button size="small" [fill]="filterState.productFilterMode === 'has' ? 'solid' : 'outline'"
            (click)="onProductFilterModeChange('has')">
            Has Product
          </ion-button>
          <ion-button size="small" [fill]="filterState.productFilterMode === 'doesntHave' ? 'solid' : 'outline'"
            (click)="onProductFilterModeChange('doesntHave')">
            Doesn't Have
          </ion-button>
        </div>
      </div>
      <div class="filter-content">
        <div class="chip-grid">
          <ion-chip *ngFor="let product of products$ | async"
            [outline]="!filterState.selectedProducts.includes(product)"
            [class.selected-chip]="filterState.selectedProducts.includes(product)" (click)="onProductChange(product)">
            <ion-label>{{ product }}</ion-label>
            <ion-badge>{{ (productCounts$ | async)?.get(product) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Feeds Filter -->
    <div class="filter-group">
      <div class="filter-header feeds-filter-header" (click)="toggleFeedsFilter()">
        <span>Filter by Active Feeds</span>
        <ion-icon [name]="showFeedsFilter ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
      </div>
      <div class="filter-content" *ngIf="showFeedsFilter">
        <div class="chip-grid">
          <ion-chip *ngFor="let feed of feeds$ | async" [outline]="!filterState.selectedFeeds.includes(feed)"
            [class.selected-chip]="filterState.selectedFeeds.includes(feed)" (click)="onFeedChange(feed)">
            <ion-label>{{ feed }}</ion-label>
            <ion-badge>{{ (feedCounts$ | async)?.get(feed) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

  </div> <!-- CLOSE filter-section HERE -->


  <!-- Client Details Section Header -->
  <div class="section-title">
    <h2>Client Details</h2>
    <span class="client-count">{{ (filteredCompanies$ | async)?.length || 0 }} clients</span>
  </div>

  <!-- Client Search Bar 
  <ion-searchbar placeholder="name, province, city, suburb, manager..." [value]="filterState.searchTerm"
    (ionChange)="onSearchChange($event)" class="custom-searchbar duplicate-searchbar">
  </ion-searchbar> 
  -->
  
  <ion-searchbar 
    placeholder="name, province, city, suburb, manager..." 
    [value]="filterState.searchTerm"
    (ionInput)="onSearchChange($event)" 
    class="custom-searchbar duplicate-searchbar">
  </ion-searchbar>

  <!-- Add this temporarily below the search bar to see if it's updating -->
  <div>Current search: {{ filterState.searchTerm }}</div>

  <!-- Client List - NOW OUTSIDE filter-section -->
  <div class="client-list">
    <div class="client-card" *ngFor="let company of filteredCompanies$ | async">
      <div class="card-header" (click)="toggleCard(company.companyId)">
        <div class="header-content">
          <div class="trading-name" [class.overdue]="isOverdue(company.lastSiteVisit)">
            {{ company.tradingName }}
          </div>
          <div class="subtitle">
            {{ company.suburb }}, {{ company.province }} · {{ calculateAge(company.startDate) }} · {{
            company.accountManager }}
          </div>
        </div>
        <div class="expand-icon">
          <ion-icon name="chevron-down-outline" [class.rotated]="isCardExpanded(company.companyId)"></ion-icon>
        </div>
      </div>

      <div class="card-body" *ngIf="isCardExpanded(company.companyId)">
        <ion-card-content>

          <!-- Client Details Section -->
          <div class="section-header green-header">Client Details</div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Manager:</span>
              <span class="value">{{ company.accountManager }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Start Date:</span>
              <span class="value">{{ company.startDate | date:'d MMMM yyyy' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Last Visit:</span>
              <span class="value">{{ company.lastSiteVisit | date:'d MMMM yyyy' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Payment:</span>
              <span class="value">{{ company.paymentMethod }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Company ID:</span>
              <span class="value">{{ company.companyId }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Last Invoice:</span>
              <span class="value">{{ company.lastInvoiceAmount | currency:'ZAR':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="detail-item full-width">
              <span class="label">Location:</span>
              <span class="value location-link" (click)="openMap(company)">
                <ion-icon name="location-outline"></ion-icon> View on Map
              </span>
            </div>
          </div>

          <!-- Active Products Section -->
          <div class="section-header green-header">Active Products</div>
          <div class="checkbox-list">
            <div class="checkbox-item" *ngFor="let product of getActiveProducts(company)">
              <ion-icon name="checkmark-circle" class="check-icon"></ion-icon>
              <span>{{ product }}</span>
            </div>
            <div class="no-data" *ngIf="getActiveProducts(company).length === 0">
              No active products.
            </div>
          </div>

          <!-- Active Feeds Section -->
          <div class="section-header green-header">Active Feeds</div>
          <div class="checkbox-list">
            <div class="checkbox-item" *ngFor="let feed of getActiveFeeds(company)">
              <ion-icon name="checkmark-circle" class="check-icon"></ion-icon>
              <span>{{ feed }}</span>
            </div>
            <div class="no-data" *ngIf="getActiveFeeds(company).length === 0">
              No active feeds.
            </div>
          </div>

          <!-- DB Info Section -->
          <div class="section-header green-header">DB Info</div>
          <div class="db-info-list">
            <div class="db-card" *ngFor="let db of company.dbInfo">
              <div class="db-row">
                <span class="label">Server Address:</span>
                <span class="value">{{ db.serverAddress }}</span>
              </div>
              <div class="db-row">
                <span class="label">Install Date:</span>
                <span class="value">{{ db.dbInstallDate | date:'d MMMM yyyy' }}</span>
              </div>
            </div>
            <div class="no-data" *ngIf="!company.dbInfo?.length">
              No DB info available.
            </div>
          </div>

          <!-- Activity Section -->
          <div class="section-header green-header">Recent Activity</div>
          <div class="activity-list">
            <div class="activity-item" *ngFor="let act of company.activity">
              <div class="item-header">
                <span class="ticket-id">Ticket: {{ act.id }}</span>
                <span class="staff-name">BY: {{ act.staffMember }}</span>
                <span class="date">{{ act.date | date:'MMM d yyyy h:mm:ss a' }}</span>
              </div>
              <div class="item-content">
                {{ act.notes }}
              </div>
            </div>
            <div class="no-data" *ngIf="!company.activity?.length">
              No activities found in the last 120 days.
            </div>
          </div>

        </ion-card-content>
      </div>