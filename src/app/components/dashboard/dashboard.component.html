<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title color="dark">FrontMan</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleMap()">
        <ion-icon [name]="showMap ? 'list-outline' : 'map-outline'"></ion-icon>
      </ion-button>
      <ion-button (click)="toggleFilters()">
        <ion-icon name="filter-outline"></ion-icon>
      </ion-button>
      <ion-button (click)="logout()" color="danger" class="logout-button">
        <ion-icon name="log-out-outline" size="large" slot="start"></ion-icon>
        Logout
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Search Bar -->
  <ion-searchbar placeholder="Search by name, province, city, suburb, or manager..." [value]="filterState.searchTerm"
    (ionChange)="onSearchChange($event)" class="custom-searchbar">
  </ion-searchbar>

  <!-- Map View (Always Visible) -->
  <div class="map-wrapper">
    <app-map-view [clients]="(filteredCompanies$ | async) ?? []"></app-map-view>
  </div>

  <!-- Unvisited Stats -->
  <ion-card class="stats-card" *ngIf="overdueStats$ | async as stats">
    <ion-card-content>
      <div class="stats-text">Unvisited in last 60 days</div>
      <div class="stats-percentage">{{ stats.percentage | number:'1.1-1' }}%</div>
      <div class="stats-count">{{ stats.count }} of {{ (filteredCompanies$ | async)?.length }} clients</div>
    </ion-card-content>
  </ion-card>

  <!-- Filter Panel -->
  <div class="filter-section">

    <!-- Manager Filter -->
    <div class="filter-group">
      <div class="filter-header">
        Filter by Account Manager
      </div>
      <div class="filter-content">
        <div class="chip-container">
          <ion-chip *ngFor="let manager of managers$ | async" [outline]="filterState.selectedManager !== manager"
            [color]="filterState.selectedManager === manager ? 'primary' : 'medium'"
            (click)="onManagerChange({detail: {value: manager}})">
            <ion-label>{{ manager }}</ion-label>
            <ion-badge *ngIf="filterState.selectedManager !== manager" color="light">{{ (managerCounts$ |
              async)?.get(manager) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Region Filter -->
    <div class="filter-group">
      <div class="filter-header">
        Filter by Region
      </div>
      <div class="filter-content">
        <ion-segment [value]="filterState.selectedRegion" (ionChange)="onRegionChange($event)" mode="ios">
          <ion-segment-button value="All">
            <ion-label>ALL</ion-label>
          </ion-segment-button>
          <ion-segment-button value="Inland">
            <ion-label>INLAND ({{ inlandCount$ | async }})</ion-label>
          </ion-segment-button>
          <ion-segment-button value="Coastal">
            <ion-label>COASTAL ({{ coastalCount$ | async }})</ion-label>
          </ion-segment-button>
        </ion-segment>

        <div class="province-chips ion-margin-top">
          <ion-chip *ngFor="let province of provinces$ | async" [outline]="filterState.selectedProvince !== province"
            [color]="filterState.selectedProvince === province ? 'primary' : 'medium'"
            (click)="onProvinceChange({detail: {value: province}})">
            <ion-label>{{ province }}</ion-label>
            <ion-badge *ngIf="filterState.selectedProvince !== province" color="light">{{ (provinceCounts$ |
              async)?.get(province) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Product Filter -->
    <div class="filter-group">
      <div class="filter-header product-filter-header">
        <span>Filter by Product</span>
        <div class="product-filter-toggle">
          <ion-button size="small" [fill]="filterState.productFilterMode === 'has' ? 'solid' : 'outline'"
            [color]="filterState.productFilterMode === 'has' ? 'light' : 'medium'"
            (click)="onProductFilterModeChange('has')">
            Has Product
          </ion-button>
          <ion-button size="small" [fill]="filterState.productFilterMode === 'doesntHave' ? 'solid' : 'outline'"
            [color]="filterState.productFilterMode === 'doesntHave' ? 'light' : 'medium'"
            (click)="onProductFilterModeChange('doesntHave')">
            Doesn't Have
          </ion-button>
        </div>
      </div>
      <div class="filter-content">
        <div class="chip-container">
          <ion-chip *ngFor="let product of products$ | async"
            [outline]="!filterState.selectedProducts.includes(product)"
            [color]="filterState.selectedProducts.includes(product) ? 'primary' : 'medium'"
            (click)="onProductChange(product)">
            <ion-label>{{ product }}</ion-label>
            <ion-badge *ngIf="!filterState.selectedProducts.includes(product)" color="light">{{ (productCounts$ |
              async)?.get(product) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Feeds Filter -->
    <div class="filter-group">
      <div class="filter-header feeds-filter-header" (click)="toggleFeedsFilter()">
        <span>Filter by Active Feeds</span>
        <ion-icon [name]="showFeedsFilter ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
      </div>
      <div class="filter-content" *ngIf="showFeedsFilter">
        <div class="chip-container">
          <ion-chip *ngFor="let feed of feeds$ | async" [outline]="!filterState.selectedFeeds.includes(feed)"
            [color]="filterState.selectedFeeds.includes(feed) ? 'primary' : 'medium'" (click)="onFeedChange(feed)">
            <ion-label>{{ feed }}</ion-label>
            <ion-badge *ngIf="!filterState.selectedFeeds.includes(feed)" color="light">{{ (feedCounts$ |
              async)?.get(feed) || 0 }}</ion-badge>
          </ion-chip>
        </div>
      </div>
    </div>

  </div>

  <!-- Client List -->
  <h3 class="list-title">Customer Details</h3>
  <div class="client-list">
    <div class="client-card" *ngFor="let company of filteredCompanies$ | async">
      <div class="card-header" (click)="toggleCard(company.companyId)">
        <div class="header-content">
          <div class="trading-name" [class.overdue]="isOverdue(company.lastSiteVisit)">
            {{ company.tradingName }}
          </div>
          <div class="subtitle">
            {{ company.suburb }}, {{ company.province }} · {{ calculateAge(company.startDate) }} · {{
            company.accountManager }}
          </div>
        </div>
        <div class="expand-icon">
          <ion-icon name="chevron-down-outline" [class.rotated]="isCardExpanded(company.companyId)"></ion-icon>
        </div>
      </div>

      <div class="card-body" *ngIf="isCardExpanded(company.companyId)">
        <ion-card-content>

          <!-- Client Details -->
          <div class="section-header">Client Details</div>
          <div class="info-list">
            <div class="info-item">
              <span class="label">Manager:</span>
              <span class="value">{{ company.accountManager }}</span>
            </div>
            <div class="info-item">
              <span class="label">Start Date:</span>
              <span class="value">{{ company.startDate | date:'d MMMM yyyy' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Last Visit:</span>
              <span class="value">{{ company.lastSiteVisit | date:'d MMMM yyyy' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Payment:</span>
              <span class="value">{{ company.paymentMethod }}</span>
            </div>
            <div class="info-item">
              <span class="label">Company ID:</span>
              <span class="value">{{ company.companyId }}</span>
            </div>
            <div class="info-item">
              <span class="label">Last Invoice:</span>
              <span class="value">{{ company.lastInvoiceAmount | currency:'ZAR':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Location:</span>
              <span class="value location-link">
                <ion-icon name="location-outline"></ion-icon> View on Map
              </span>
            </div>
          </div>

          <!-- Active Products -->
          <div class="section-header">Active Products</div>
          <div class="check-list">
            <div class="check-item" *ngFor="let product of company.products | keyvalue">
              <ng-container *ngIf="product.value">
                <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                <span>{{ product.key }}</span>
              </ng-container>
            </div>
          </div>

          <!-- Active Feeds -->
          <div class="section-header">Active Feeds</div>
          <div class="check-list">
            <div class="check-item" *ngFor="let feed of company.feeds | keyvalue">
              <ng-container *ngIf="feed.value">
                <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                <span>{{ feed.key }}</span>
              </ng-container>
            </div>
          </div>

          <!-- DB Info -->
          <div class="section-header">DB Info</div>
          <div class="db-info-list">
            <div class="db-card" *ngFor="let db of company.dbInfo">
              <div class="db-row">
                <span class="label">Server Address:</span>
                <span class="value">{{ db.serverAddress }}</span>
              </div>
              <div class="db-row">
                <span class="label">Install Date:</span>
                <span class="value">{{ db.installDate | date:'MMM d yyyy h:mm:ss:a' }}</span>
              </div>
            </div>
            <div class="no-data" *ngIf="!company.dbInfo?.length">
              No DB info available.
            </div>
          </div>

          <!-- Activity -->
          <div class="section-header">Activity Last 120 Days</div>
          <div class="activity-list">
            <div class="activity-item" *ngFor="let act of company.activity">
              <div class="item-header">
                <span class="ticket-id">Ticket: {{ act.activityId }}</span>
                <span class="staff-name">By: {{ act.performedBy }}</span>
                <span class="date">{{ act.date | date:'MMM d yyyy h:mm:ss:a' }}</span>
              </div>
              <div class="item-content">
                {{ act.notes || act.description }}
              </div>
            </div>
            <div class="no-data" *ngIf="!company.activity?.length">
              No activities found in the last 120 days.
            </div>
          </div>

        </ion-card-content>
      </div>
    </div>
  </div>

</ion-content>